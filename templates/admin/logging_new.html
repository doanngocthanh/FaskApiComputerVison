{% extends "admin/base.html" %}

{% block title %}Logging Management - Admin Panel{% endblock %}

{% block page_title %}Logging Management{% endblock %}
{% block page_subtitle %}Monitor and configure endpoint logging{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Logs</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-logs">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Log File Size</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="file-size">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-database fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Endpoints</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="active-endpoints">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-toggle-on fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Logging Status</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="logging-status">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <ul class="nav nav-tabs card-header-tabs" id="loggingTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#endpoint-config">Endpoint Configuration</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#log-viewer">Log Viewer</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#global-settings">Global Settings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#log-management">Log Management</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <!-- Endpoint Configuration Tab -->
                <div class="tab-pane fade show active" id="endpoint-config">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Endpoint Logging Configuration</h5>
                        <button class="btn btn-primary btn-sm" onclick="refreshEndpoints()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="endpoints-table">
                            <thead>
                                <tr>
                                    <th>Method</th>
                                    <th>Path</th>
                                    <th>Description</th>
                                    <th>Logging Enabled</th>
                                    <th>Log Request Body</th>
                                    <th>Log Response Body</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Log Viewer Tab -->
                <div class="tab-pane fade" id="log-viewer">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h5>Search and Filter Logs</h5>
                            <form id="log-search-form" class="row g-3">
                                <div class="col-md-3">
                                    <label>Start Date:</label>
                                    <input type="datetime-local" id="start-date" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label>End Date:</label>
                                    <input type="datetime-local" id="end-date" class="form-control">
                                </div>
                                <div class="col-md-2">
                                    <label>Method:</label>
                                    <select id="method-filter" class="form-control">
                                        <option value="">All Methods</option>
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                        <option value="PUT">PUT</option>
                                        <option value="DELETE">DELETE</option>
                                        <option value="PATCH">PATCH</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label>Status Code:</label>
                                    <input type="number" id="status-filter" class="form-control" placeholder="200, 404, etc.">
                                </div>
                                <div class="col-md-2">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary form-control">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                            </form>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <input type="text" id="endpoint-filter" class="form-control" placeholder="Filter by endpoint path...">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" id="ip-filter" class="form-control" placeholder="Filter by IP address...">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-secondary form-control" onclick="clearFilters()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="logs-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Method</th>
                                    <th>Path</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                    <th>Response Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="log-count">0</span> logs found
                        </div>
                        <div>
                            <button class="btn btn-outline-primary" onclick="exportLogs()">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Global Settings Tab -->
                <div class="tab-pane fade" id="global-settings">
                    <h5>Global Logging Configuration</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0">General Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Enable Logging Globally:</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="global-logging-enabled">
                                            <label class="form-check-label" for="global-logging-enabled">
                                                Enable request/response logging
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Log Level:</label>
                                        <select id="global-log-level" class="form-control">
                                            <option value="DEBUG">DEBUG</option>
                                            <option value="INFO">INFO</option>
                                            <option value="WARNING">WARNING</option>
                                            <option value="ERROR">ERROR</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0">Body Logging</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="global-log-request-body">
                                            <label class="form-check-label" for="global-log-request-body">
                                                Log Request Bodies
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="global-log-response-body">
                                            <label class="form-check-label" for="global-log-response-body">
                                                Log Response Bodies
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Max Body Size (bytes):</label>
                                        <input type="number" id="global-max-body-size" class="form-control" min="100" max="10000" value="1000">
                                        <small class="form-text text-muted">Maximum size of request/response body to log</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveGlobalSettings()">
                            <i class="fas fa-save"></i> Save Global Settings
                        </button>
                    </div>
                </div>

                <!-- Log Management Tab -->
                <div class="tab-pane fade" id="log-management">
                    <h5>Log File Management</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0">Log Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Total Log Entries:</strong></td>
                                            <td id="stats-total-logs">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Log File Size:</strong></td>
                                            <td id="stats-file-size">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Oldest Log:</strong></td>
                                            <td id="stats-oldest-log">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Newest Log:</strong></td>
                                            <td id="stats-newest-log">-</td>
                                        </tr>
                                    </table>
                                    
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshLogStats()">
                                        <i class="fas fa-sync-alt"></i> Refresh Stats
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0">Log Cleanup</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Keep logs for:</label>
                                        <select id="cleanup-days" class="form-control">
                                            <option value="1">1 day</option>
                                            <option value="3">3 days</option>
                                            <option value="7" selected>7 days</option>
                                            <option value="14">14 days</option>
                                            <option value="30">30 days</option>
                                            <option value="90">90 days</option>
                                        </select>
                                    </div>
                                    
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>Warning:</strong> This action will permanently delete older logs.
                                    </div>
                                    
                                    <button class="btn btn-danger" onclick="clearOldLogs()">
                                        <i class="fas fa-trash"></i> Clear Old Logs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Detail Modal -->
<div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="log-detail-content"></pre>
            </div>
        </div>
    </div>
</div>

<script>
let endpointsData = [];
let logsData = [];

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadEndpoints();
    loadLogStats();
    loadGlobalSettings();
});

async function loadEndpoints() {
    try {
        showLoading();
        
        const response = await auth.fetch('/api/admin/logging/endpoints');
        if (response && response.ok) {
            const data = await response.json();
            endpointsData = data.endpoints;
            updateEndpointsTable();
            document.getElementById('active-endpoints').textContent = 
                endpointsData.filter(e => e.logging_config.enabled).length;
        }
    } catch (error) {
        console.error('Failed to load endpoints:', error);
        showToast('Failed to load endpoints', 'danger');
    } finally {
        hideLoading();
    }
}

function updateEndpointsTable() {
    const tbody = document.querySelector('#endpoints-table tbody');
    tbody.innerHTML = '';
    
    endpointsData.forEach(endpoint => {
        const row = tbody.insertRow();
        const config = endpoint.logging_config;
        
        row.innerHTML = `
            <td><span class="badge badge-${getMethodColor(endpoint.method)}">${endpoint.method}</span></td>
            <td><code>${endpoint.path}</code></td>
            <td>${endpoint.description || '-'}</td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" ${config.enabled ? 'checked' : ''} 
                           onchange="toggleEndpointLogging('${endpoint.path}', this.checked)">
                </div>
            </td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" ${config.log_request_body ? 'checked' : ''} 
                           onchange="toggleRequestBodyLogging('${endpoint.path}', this.checked)">
                </div>
            </td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" ${config.log_response_body ? 'checked' : ''} 
                           onchange="toggleResponseBodyLogging('${endpoint.path}', this.checked)">
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="configureEndpoint('${endpoint.path}')">
                    <i class="fas fa-cog"></i> Configure
                </button>
            </td>
        `;
    });
}

function getMethodColor(method) {
    const colors = {
        'GET': 'success',
        'POST': 'primary',
        'PUT': 'warning',
        'DELETE': 'danger',
        'PATCH': 'info'
    };
    return colors[method] || 'secondary';
}

async function toggleEndpointLogging(path, enabled) {
    try {
        const endpoint = endpointsData.find(e => e.path === path);
        if (!endpoint) return;
        
        const config = {
            enabled: enabled,
            log_request_body: endpoint.logging_config.log_request_body,
            log_response_body: endpoint.logging_config.log_response_body
        };
        
        const response = await auth.fetch(`/api/admin/logging/endpoints/${encodeURIComponent(path)}/config`, {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        if (response && response.ok) {
            endpoint.logging_config.enabled = enabled;
            showToast(`Logging ${enabled ? 'enabled' : 'disabled'} for ${path}`, 'success');
            document.getElementById('active-endpoints').textContent = 
                endpointsData.filter(e => e.logging_config.enabled).length;
        }
    } catch (error) {
        console.error('Failed to toggle endpoint logging:', error);
        showToast('Failed to update logging config', 'danger');
    }
}

async function toggleRequestBodyLogging(path, enabled) {
    try {
        const endpoint = endpointsData.find(e => e.path === path);
        if (!endpoint) return;
        
        const config = {
            enabled: endpoint.logging_config.enabled,
            log_request_body: enabled,
            log_response_body: endpoint.logging_config.log_response_body
        };
        
        const response = await auth.fetch(`/api/admin/logging/endpoints/${encodeURIComponent(path)}/config`, {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        if (response && response.ok) {
            endpoint.logging_config.log_request_body = enabled;
            showToast(`Request body logging ${enabled ? 'enabled' : 'disabled'} for ${path}`, 'success');
        }
    } catch (error) {
        console.error('Failed to toggle request body logging:', error);
        showToast('Failed to update logging config', 'danger');
    }
}

async function toggleResponseBodyLogging(path, enabled) {
    try {
        const endpoint = endpointsData.find(e => e.path === path);
        if (!endpoint) return;
        
        const config = {
            enabled: endpoint.logging_config.enabled,
            log_request_body: endpoint.logging_config.log_request_body,
            log_response_body: enabled
        };
        
        const response = await auth.fetch(`/api/admin/logging/endpoints/${encodeURIComponent(path)}/config`, {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        if (response && response.ok) {
            endpoint.logging_config.log_response_body = enabled;
            showToast(`Response body logging ${enabled ? 'enabled' : 'disabled'} for ${path}`, 'success');
        }
    } catch (error) {
        console.error('Failed to toggle response body logging:', error);
        showToast('Failed to update logging config', 'danger');
    }
}

async function loadLogStats() {
    try {
        const response = await auth.fetch('/api/admin/logging/stats');
        if (response && response.ok) {
            const data = await response.json();
            const stats = data.stats;
            
            document.getElementById('total-logs').textContent = stats.total_logs.toLocaleString();
            document.getElementById('file-size').textContent = `${stats.file_size_mb} MB`;
            document.getElementById('stats-total-logs').textContent = stats.total_logs.toLocaleString();
            document.getElementById('stats-file-size').textContent = `${stats.file_size_mb} MB`;
            document.getElementById('stats-oldest-log').textContent = stats.oldest_log || 'No logs';
            document.getElementById('stats-newest-log').textContent = stats.newest_log || 'No logs';
            document.getElementById('logging-status').textContent = stats.total_logs > 0 ? 'Active' : 'Inactive';
        }
    } catch (error) {
        console.error('Failed to load log stats:', error);
    }
}

async function loadGlobalSettings() {
    try {
        const response = await auth.fetch('/api/admin/logging/endpoints');
        if (response && response.ok) {
            const data = await response.json();
            const config = data.global_config;
            
            document.getElementById('global-logging-enabled').checked = config.enabled || false;
            document.getElementById('global-log-level').value = config.log_level || 'INFO';
            document.getElementById('global-log-request-body').checked = config.log_request_body || false;
            document.getElementById('global-log-response-body').checked = config.log_response_body || false;
            document.getElementById('global-max-body-size').value = config.max_body_size || 1000;
        }
    } catch (error) {
        console.error('Failed to load global settings:', error);
    }
}

async function saveGlobalSettings() {
    try {
        showLoading();
        
        const config = {
            enabled: document.getElementById('global-logging-enabled').checked,
            log_level: document.getElementById('global-log-level').value,
            log_request_body: document.getElementById('global-log-request-body').checked,
            log_response_body: document.getElementById('global-log-response-body').checked,
            max_body_size: parseInt(document.getElementById('global-max-body-size').value)
        };
        
        const response = await auth.fetch('/api/admin/logging/global-config', {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        if (response && response.ok) {
            showToast('Global settings saved successfully', 'success');
        }
    } catch (error) {
        console.error('Failed to save global settings:', error);
        showToast('Failed to save global settings', 'danger');
    } finally {
        hideLoading();
    }
}

document.getElementById('log-search-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    await searchLogs();
});

async function searchLogs() {
    try {
        showLoading();
        
        const searchRequest = {
            start_date: document.getElementById('start-date').value || null,
            end_date: document.getElementById('end-date').value || null,
            endpoint: document.getElementById('endpoint-filter').value || null,
            ip_address: document.getElementById('ip-filter').value || null,
            status_code: document.getElementById('status-filter').value ? parseInt(document.getElementById('status-filter').value) : null,
            method: document.getElementById('method-filter').value || null,
            limit: 100
        };
        
        const response = await auth.fetch('/api/admin/logging/search', {
            method: 'POST',
            body: JSON.stringify(searchRequest)
        });
        
        if (response && response.ok) {
            const data = await response.json();
            logsData = data.logs;
            updateLogsTable();
            document.getElementById('log-count').textContent = data.logs.length;
        }
    } catch (error) {
        console.error('Failed to search logs:', error);
        showToast('Failed to search logs', 'danger');
    } finally {
        hideLoading();
    }
}

function updateLogsTable() {
    const tbody = document.querySelector('#logs-table tbody');
    tbody.innerHTML = '';
    
    logsData.forEach(log => {
        const row = tbody.insertRow();
        const request = log.data.request || {};
        const response = log.data.response || {};
        
        row.innerHTML = `
            <td>${new Date(log.timestamp).toLocaleString()}</td>
            <td><span class="badge badge-${getMethodColor(request.method)}">${request.method || 'N/A'}</span></td>
            <td><code>${request.path || 'N/A'}</code></td>
            <td>${request.client_ip || 'N/A'}</td>
            <td><span class="badge badge-${getStatusColor(response.status_code)}">${response.status_code || 'N/A'}</span></td>
            <td>${log.data.process_time_ms ? log.data.process_time_ms + 'ms' : 'N/A'}</td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="showLogDetail(${logsData.indexOf(log)})">
                    <i class="fas fa-eye"></i> View
                </button>
            </td>
        `;
    });
}

function getStatusColor(status) {
    if (status >= 500) return 'danger';
    if (status >= 400) return 'warning';
    if (status >= 300) return 'info';
    if (status >= 200) return 'success';
    return 'secondary';
}

function showLogDetail(index) {
    const log = logsData[index];
    document.getElementById('log-detail-content').textContent = JSON.stringify(log.data, null, 2);
    const modal = new bootstrap.Modal(document.getElementById('logDetailModal'));
    modal.show();
}

function clearFilters() {
    document.getElementById('start-date').value = '';
    document.getElementById('end-date').value = '';
    document.getElementById('endpoint-filter').value = '';
    document.getElementById('ip-filter').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('method-filter').value = '';
}

async function clearOldLogs() {
    if (!confirm('Are you sure you want to clear old logs? This action cannot be undone.')) {
        return;
    }
    
    try {
        showLoading();
        
        const days = parseInt(document.getElementById('cleanup-days').value);
        
        const response = await auth.fetch(`/api/admin/logging/clear?days_to_keep=${days}`, {
            method: 'DELETE'
        });
        
        if (response && response.ok) {
            const data = await response.json();
            showToast(data.message, 'success');
            loadLogStats();
        }
    } catch (error) {
        console.error('Failed to clear logs:', error);
        showToast('Failed to clear logs', 'danger');
    } finally {
        hideLoading();
    }
}

function refreshEndpoints() {
    loadEndpoints();
}

function refreshLogStats() {
    loadLogStats();
}

function exportLogs() {
    if (logsData.length === 0) {
        showToast('No logs to export', 'warning');
        return;
    }
    
    // Create CSV content
    const headers = ['Timestamp', 'Method', 'Path', 'IP Address', 'Status Code', 'Response Time (ms)', 'User Agent'];
    const csvContent = [
        headers.join(','),
        ...logsData.map(log => {
            const request = log.data.request || {};
            const response = log.data.response || {};
            return [
                `"${log.timestamp}"`,
                `"${request.method || ''}"`,
                `"${request.path || ''}"`,
                `"${request.client_ip || ''}"`,
                response.status_code || '',
                log.data.process_time_ms || '',
                `"${request.user_agent || ''}"`
            ].join(',');
        })
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `logs_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
