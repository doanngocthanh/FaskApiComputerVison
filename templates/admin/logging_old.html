{% extends "admin/base.html" %}

{% block title %}Logging Management - Admin Panel{% endblock %}

{% block page_title %}Logging Management{% endblock %}
{% block page_subtitle %}Monitor and configure endpoint logging{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Logs</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-logs">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Log File Size</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="file-size">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-database fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Endpoints</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="active-endpoints">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-toggle-on fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Logging Status</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="logging-status">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <ul class="nav nav-tabs card-header-tabs" id="loggingTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#endpoint-config">Endpoint Configuration</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#log-viewer">Log Viewer</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#global-settings">Global Settings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#log-management">Log Management</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <!-- Endpoint Configuration Tab -->
                <div class="tab-pane fade show active" id="endpoint-config">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Endpoint Logging Configuration</h5>
                        <button class="btn btn-primary btn-sm" onclick="refreshEndpoints()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="endpoints-table">
                            <thead>
                                <tr>
                                    <th>Method</th>
                                    <th>Path</th>
                                    <th>Description</th>
                                    <th>Logging Enabled</th>
                                    <th>Log Request Body</th>
                                    <th>Log Response Body</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Log Viewer Tab -->
                <div class="tab-pane fade" id="log-viewer">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h5>Search and Filter Logs</h5>
                            <form id="log-search-form" class="row g-3">
                                <div class="col-md-3">
                                    <label>Start Date:</label>
                                    <input type="datetime-local" id="start-date" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label>End Date:</label>
                                    <input type="datetime-local" id="end-date" class="form-control">
                                </div>
                                <div class="col-md-2">
                                    <label>Method:</label>
                                    <select id="method-filter" class="form-control">
                                        <option value="">All Methods</option>
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                        <option value="PUT">PUT</option>
                                        <option value="DELETE">DELETE</option>
                                        <option value="PATCH">PATCH</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label>Status Code:</label>
                                    <input type="number" id="status-filter" class="form-control" placeholder="200, 404, etc.">
                                </div>
                                <div class="col-md-2">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary form-control">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                            </form>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <input type="text" id="endpoint-filter" class="form-control" placeholder="Filter by endpoint path...">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" id="ip-filter" class="form-control" placeholder="Filter by IP address...">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-secondary form-control" onclick="clearFilters()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="logs-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Method</th>
                                    <th>Path</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                    <th>Response Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="log-count">0</span> logs found
                        </div>
                        <div>
                            <button class="btn btn-outline-primary" onclick="exportLogs()">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Global Settings Tab -->
                <div class="tab-pane fade" id="global-settings">
                    <h5>Global Logging Configuration</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0">General Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Enable Logging Globally:</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="global-logging-enabled">
                                            <label class="form-check-label" for="global-logging-enabled">
                                                Enable request/response logging
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Log Level:</label>
                                        <select id="global-log-level" class="form-control">
                                            <option value="DEBUG">DEBUG</option>
                                            <option value="INFO">INFO</option>
                                            <option value="WARNING">WARNING</option>
                                            <option value="ERROR">ERROR</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0">Body Logging</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="global-log-request-body">
                                            <label class="form-check-label" for="global-log-request-body">
                                                Log Request Bodies
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="global-log-response-body">
                                            <label class="form-check-label" for="global-log-response-body">
                                                Log Response Bodies
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Max Body Size (bytes):</label>
                                        <input type="number" id="global-max-body-size" class="form-control" min="100" max="10000" value="1000">
                                        <small class="form-text text-muted">Maximum size of request/response body to log</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveGlobalSettings()">
                            <i class="fas fa-save"></i> Save Global Settings
                        </button>
                    </div>
                </div>

                <!-- Log Management Tab -->
                <div class="tab-pane fade" id="log-management">
                    <h5>Log File Management</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0">Log Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Total Log Entries:</strong></td>
                                            <td id="stats-total-logs">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Log File Size:</strong></td>
                                            <td id="stats-file-size">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Oldest Log:</strong></td>
                                            <td id="stats-oldest-log">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Newest Log:</strong></td>
                                            <td id="stats-newest-log">-</td>
                                        </tr>
                                    </table>
                                    
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshLogStats()">
                                        <i class="fas fa-sync-alt"></i> Refresh Stats
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0">Log Cleanup</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Keep logs for:</label>
                                        <select id="cleanup-days" class="form-control">
                                            <option value="1">1 day</option>
                                            <option value="3">3 days</option>
                                            <option value="7" selected>7 days</option>
                                            <option value="14">14 days</option>
                                            <option value="30">30 days</option>
                                            <option value="90">90 days</option>
                                        </select>
                                    </div>
                                    
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>Warning:</strong> This action will permanently delete older logs.
                                    </div>
                                    
                                    <button class="btn btn-danger" onclick="clearOldLogs()">
                                        <i class="fas fa-trash"></i> Clear Old Logs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Detail Modal -->
<div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="log-detail-content"></pre>
            </div>
        </div>
    </div>
</div>

<script>
let endpointsData = [];
let logsData = [];

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadEndpoints();
    loadLogStats();
    loadGlobalSettings();
});

async function loadEndpoints() {
    try {
        showLoading();
        
        const response = await auth.fetch('/api/admin/logging/endpoints');
        if (response && response.ok) {
            const data = await response.json();
            endpointsData = data.endpoints;
            updateEndpointsTable();
            document.getElementById('active-endpoints').textContent = 
                endpointsData.filter(e => e.logging_config.enabled).length;
        }
    } catch (error) {
        console.error('Failed to load endpoints:', error);
        showToast('Failed to load endpoints', 'danger');
    } finally {
        hideLoading();
    }
}

function updateEndpointsTable() {
    const tbody = document.querySelector('#endpoints-table tbody');
    tbody.innerHTML = '';
    
    endpointsData.forEach(endpoint => {
        const row = tbody.insertRow();
        const config = endpoint.logging_config;
        
        row.innerHTML = `
            <td><span class="badge badge-${getMethodColor(endpoint.method)}">${endpoint.method}</span></td>
            <td><code>${endpoint.path}</code></td>
            <td>${endpoint.description || '-'}</td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" ${config.enabled ? 'checked' : ''} 
                           onchange="toggleEndpointLogging('${endpoint.path}', this.checked)">
                </div>
            </td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" ${config.log_request_body ? 'checked' : ''} 
                           onchange="toggleRequestBodyLogging('${endpoint.path}', this.checked)">
                </div>
            </td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" ${config.log_response_body ? 'checked' : ''} 
                           onchange="toggleResponseBodyLogging('${endpoint.path}', this.checked)">
                </div>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="configureEndpoint('${endpoint.path}')">
                    <i class="fas fa-cog"></i> Configure
                </button>
            </td>
        `;
    });
}

function getMethodColor(method) {
    const colors = {
        'GET': 'success',
        'POST': 'primary',
        'PUT': 'warning',
        'DELETE': 'danger',
        'PATCH': 'info'
    };
    return colors[method] || 'secondary';
}

async function toggleEndpointLogging(path, enabled) {
    try {
        const endpoint = endpointsData.find(e => e.path === path);
        if (!endpoint) return;
        
        const config = {
            enabled: enabled,
            log_request_body: endpoint.logging_config.log_request_body,
            log_response_body: endpoint.logging_config.log_response_body
        };
        
        const response = await auth.fetch(`/api/admin/logging/endpoints/${encodeURIComponent(path)}/config`, {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        if (response && response.ok) {
            endpoint.logging_config.enabled = enabled;
            showToast(`Logging ${enabled ? 'enabled' : 'disabled'} for ${path}`, 'success');
            document.getElementById('active-endpoints').textContent = 
                endpointsData.filter(e => e.logging_config.enabled).length;
        }
    } catch (error) {
        console.error('Failed to toggle endpoint logging:', error);
        showToast('Failed to update logging config', 'danger');
    }
}

async function toggleRequestBodyLogging(path, enabled) {
    try {
        const endpoint = endpointsData.find(e => e.path === path);
        if (!endpoint) return;
        
        const config = {
            enabled: endpoint.logging_config.enabled,
            log_request_body: enabled,
            log_response_body: endpoint.logging_config.log_response_body
        };
        
        const response = await auth.fetch(`/api/admin/logging/endpoints/${encodeURIComponent(path)}/config`, {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        if (response && response.ok) {
            endpoint.logging_config.log_request_body = enabled;
            showToast(`Request body logging ${enabled ? 'enabled' : 'disabled'} for ${path}`, 'success');
        }
    } catch (error) {
        console.error('Failed to toggle request body logging:', error);
        showToast('Failed to update logging config', 'danger');
    }
}

async function toggleResponseBodyLogging(path, enabled) {
    try {
        const endpoint = endpointsData.find(e => e.path === path);
        if (!endpoint) return;
        
        const config = {
            enabled: endpoint.logging_config.enabled,
            log_request_body: endpoint.logging_config.log_request_body,
            log_response_body: enabled
        };
        
        const response = await auth.fetch(`/api/admin/logging/endpoints/${encodeURIComponent(path)}/config`, {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        if (response && response.ok) {
            endpoint.logging_config.log_response_body = enabled;
            showToast(`Response body logging ${enabled ? 'enabled' : 'disabled'} for ${path}`, 'success');
        }
    } catch (error) {
        console.error('Failed to toggle response body logging:', error);
        showToast('Failed to update logging config', 'danger');
    }
}

async function loadLogStats() {
    try {
        const response = await auth.fetch('/api/admin/logging/stats');
        if (response && response.ok) {
            const data = await response.json();
            const stats = data.stats;
            
            document.getElementById('total-logs').textContent = stats.total_logs.toLocaleString();
            document.getElementById('file-size').textContent = `${stats.file_size_mb} MB`;
            document.getElementById('stats-total-logs').textContent = stats.total_logs.toLocaleString();
            document.getElementById('stats-file-size').textContent = `${stats.file_size_mb} MB`;
            document.getElementById('stats-oldest-log').textContent = stats.oldest_log || 'No logs';
            document.getElementById('stats-newest-log').textContent = stats.newest_log || 'No logs';
            document.getElementById('logging-status').textContent = stats.total_logs > 0 ? 'Active' : 'Inactive';
        }
    } catch (error) {
        console.error('Failed to load log stats:', error);
    }
}

async function loadGlobalSettings() {
    try {
        const response = await auth.fetch('/api/admin/logging/endpoints');
        if (response && response.ok) {
            const data = await response.json();
            const config = data.global_config;
            
            document.getElementById('global-logging-enabled').checked = config.enabled || false;
            document.getElementById('global-log-level').value = config.log_level || 'INFO';
            document.getElementById('global-log-request-body').checked = config.log_request_body || false;
            document.getElementById('global-log-response-body').checked = config.log_response_body || false;
            document.getElementById('global-max-body-size').value = config.max_body_size || 1000;
        }
    } catch (error) {
        console.error('Failed to load global settings:', error);
    }
}

async function saveGlobalSettings() {
    try {
        showLoading();
        
        const config = {
            enabled: document.getElementById('global-logging-enabled').checked,
            log_level: document.getElementById('global-log-level').value,
            log_request_body: document.getElementById('global-log-request-body').checked,
            log_response_body: document.getElementById('global-log-response-body').checked,
            max_body_size: parseInt(document.getElementById('global-max-body-size').value)
        };
        
        const response = await auth.fetch('/api/admin/logging/global-config', {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        if (response && response.ok) {
            showToast('Global settings saved successfully', 'success');
        }
    } catch (error) {
        console.error('Failed to save global settings:', error);
        showToast('Failed to save global settings', 'danger');
    } finally {
        hideLoading();
    }
}

document.getElementById('log-search-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    await searchLogs();
});

async function searchLogs() {
    try {
        showLoading();
        
        const searchRequest = {
            start_date: document.getElementById('start-date').value || null,
            end_date: document.getElementById('end-date').value || null,
            endpoint: document.getElementById('endpoint-filter').value || null,
            ip_address: document.getElementById('ip-filter').value || null,
            status_code: document.getElementById('status-filter').value ? parseInt(document.getElementById('status-filter').value) : null,
            method: document.getElementById('method-filter').value || null,
            limit: 100
        };
        
        const response = await auth.fetch('/api/admin/logging/search', {
            method: 'POST',
            body: JSON.stringify(searchRequest)
        });
        
        if (response && response.ok) {
            const data = await response.json();
            logsData = data.logs;
            updateLogsTable();
            document.getElementById('log-count').textContent = data.logs.length;
        }
    } catch (error) {
        console.error('Failed to search logs:', error);
        showToast('Failed to search logs', 'danger');
    } finally {
        hideLoading();
    }
}

function updateLogsTable() {
    const tbody = document.querySelector('#logs-table tbody');
    tbody.innerHTML = '';
    
    logsData.forEach(log => {
        const row = tbody.insertRow();
        const request = log.data.request || {};
        const response = log.data.response || {};
        
        row.innerHTML = `
            <td>${new Date(log.timestamp).toLocaleString()}</td>
            <td><span class="badge badge-${getMethodColor(request.method)}">${request.method || 'N/A'}</span></td>
            <td><code>${request.path || 'N/A'}</code></td>
            <td>${request.client_ip || 'N/A'}</td>
            <td><span class="badge badge-${getStatusColor(response.status_code)}">${response.status_code || 'N/A'}</span></td>
            <td>${log.data.process_time_ms ? log.data.process_time_ms + 'ms' : 'N/A'}</td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="showLogDetail(${logsData.indexOf(log)})">
                    <i class="fas fa-eye"></i> View
                </button>
            </td>
        `;
    });
}

function getStatusColor(status) {
    if (status >= 500) return 'danger';
    if (status >= 400) return 'warning';
    if (status >= 300) return 'info';
    if (status >= 200) return 'success';
    return 'secondary';
}

function showLogDetail(index) {
    const log = logsData[index];
    document.getElementById('log-detail-content').textContent = JSON.stringify(log.data, null, 2);
    const modal = new bootstrap.Modal(document.getElementById('logDetailModal'));
    modal.show();
}

function clearFilters() {
    document.getElementById('start-date').value = '';
    document.getElementById('end-date').value = '';
    document.getElementById('endpoint-filter').value = '';
    document.getElementById('ip-filter').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('method-filter').value = '';
}

async function clearOldLogs() {
    if (!confirm('Are you sure you want to clear old logs? This action cannot be undone.')) {
        return;
    }
    
    try {
        showLoading();
        
        const days = parseInt(document.getElementById('cleanup-days').value);
        
        const response = await auth.fetch(`/api/admin/logging/clear?days_to_keep=${days}`, {
            method: 'DELETE'
        });
        
        if (response && response.ok) {
            const data = await response.json();
            showToast(data.message, 'success');
            loadLogStats();
        }
    } catch (error) {
        console.error('Failed to clear logs:', error);
        showToast('Failed to clear logs', 'danger');
    } finally {
        hideLoading();
    }
}

function refreshEndpoints() {
    loadEndpoints();
}

function refreshLogStats() {
    loadLogStats();
}

function exportLogs() {
    if (logsData.length === 0) {
        showToast('No logs to export', 'warning');
        return;
    }
    
    // Create CSV content
    const headers = ['Timestamp', 'Method', 'Path', 'IP Address', 'Status Code', 'Response Time (ms)', 'User Agent'];
    const csvContent = [
        headers.join(','),
        ...logsData.map(log => {
            const request = log.data.request || {};
            const response = log.data.response || {};
            return [
                `"${log.timestamp}"`,
                `"${request.method || ''}"`,
                `"${request.path || ''}"`,
                `"${request.client_ip || ''}"`,
                response.status_code || '',
                log.data.process_time_ms || '',
                `"${request.user_agent || ''}"`
            ].join(',');
        })
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `logs_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-network-wired fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Log Files</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="log-files-count">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <ul class="nav nav-tabs card-header-tabs" id="loggingTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#global-config">Global Config</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#endpoint-config">Endpoint Config</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#view-logs">View Logs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#log-files">Log Files</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <!-- Global Configuration Tab -->
                <div class="tab-pane fade show active" id="global-config">
                    <h5>Global Logging Configuration</h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="global-enabled"> 
                                    Enable Global Logging
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label>Default Log Level:</label>
                                <select id="log-level" class="form-control">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Max Response Length (chars):</label>
                                <input type="number" id="max-response-length" class="form-control" min="100" max="10000">
                            </div>
                            
                            <div class="form-group">
                                <label>Log Retention (days):</label>
                                <input type="number" id="retention-days" class="form-control" min="1" max="365">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveGlobalConfig()">
                        <i class="fas fa-save"></i> Save Global Configuration
                    </button>
                </div>

                <!-- Endpoint Configuration Tab -->
                <div class="tab-pane fade" id="endpoint-config">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Endpoint Logging Configuration</h5>
                        <div>
                            <button class="btn btn-success btn-sm mr-2" onclick="enableAllEndpoints()">
                                <i class="fas fa-check-circle"></i> Enable All
                            </button>
                            <button class="btn btn-warning btn-sm mr-2" onclick="disableAllEndpoints()">
                                <i class="fas fa-times-circle"></i> Disable All
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="saveEndpointConfigs()">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" id="endpoint-filter" class="form-control" placeholder="Filter endpoints...">
                        </div>
                        <div class="col-md-3">
                            <select id="method-filter" class="form-control">
                                <option value="">All Methods</option>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="status-filter" class="form-control">
                                <option value="">All Status</option>
                                <option value="enabled">Enabled</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary" onclick="filterEndpoints()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                        </div>
                    </div>
                    
                    <!-- Endpoints Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered" id="endpoints-table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="select-all-endpoints" onchange="toggleAllEndpoints()">
                                    </th>
                                    <th>Method</th>
                                    <th>Path</th>
                                    <th>Enabled</th>
                                    <th>Log Level</th>
                                    <th>Request Body</th>
                                    <th>Response Body</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- View Logs Tab -->
                <div class="tab-pane fade" id="view-logs">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>View Application Logs</h5>
                        <div>
                            <select id="log-type-select" class="form-control d-inline-block" style="width: 150px;">
                                <option value="requests">Requests</option>
                                <option value="errors">Errors</option>
                                <option value="performance">Performance</option>
                            </select>
                            <button class="btn btn-primary btn-sm ml-2" onclick="loadLogs()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-info btn-sm ml-2" onclick="showSearchModal()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    
                    <!-- Log Entries -->
                    <div id="log-entries" class="bg-dark text-light p-3" style="height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        Loading logs...
                    </div>
                    
                    <!-- Log Controls -->
                    <div class="mt-3">
                        <div class="form-group">
                            <label>Number of entries:</label>
                            <select id="log-limit" class="form-control d-inline-block" style="width: 100px;">
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                                <option value="500">500</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Log Files Tab -->
                <div class="tab-pane fade" id="log-files">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Log Files Management</h5>
                        <div>
                            <button class="btn btn-warning btn-sm mr-2" onclick="clearOldLogs()">
                                <i class="fas fa-broom"></i> Clear Old Logs
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="clearAllLogs()">
                                <i class="fas fa-trash"></i> Clear All Logs
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered" id="log-files-table">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Size</th>
                                    <th>Lines</th>
                                    <th>Last Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Start Date:</label>
                            <input type="datetime-local" id="search-start-date" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>End Date:</label>
                            <input type="datetime-local" id="search-end-date" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Client IP:</label>
                            <input type="text" id="search-client-ip" class="form-control" placeholder="192.168.1.1">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Path:</label>
                            <input type="text" id="search-path" class="form-control" placeholder="/api/admin">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Method:</label>
                            <select id="search-method" class="form-control">
                                <option value="">Any</option>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Status Code:</label>
                            <input type="number" id="search-status-code" class="form-control" placeholder="200">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Min Response Time (ms):</label>
                            <input type="number" id="search-min-response-time" class="form-control" placeholder="1000">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Log Level:</label>
                    <select id="search-log-level" class="form-control">
                        <option value="">Any</option>
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO">INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="searchLogs()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let endpointsData = [];
let currentConfig = {};

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAllData();
});

async function loadAllData() {
    try {
        showLoading();
        
        // Load all data in parallel
        await Promise.all([
            loadGlobalConfig(),
            loadEndpoints(),
            loadStats(),
            loadLogFiles()
        ]);
        
        // Load initial logs
        loadLogs();
        
    } catch (error) {
        console.error('Failed to load logging data:', error);
        showToast('Failed to load logging data', 'danger');
    } finally {
        hideLoading();
    }
}

async function loadGlobalConfig() {
    try {
        const response = await auth.fetch('/api/admin/logging/config');
        if (response && response.ok) {
            const data = await response.json();
            currentConfig = data.config;
            
            document.getElementById('global-enabled').checked = data.config.global_enabled;
            document.getElementById('log-level').value = data.config.log_level;
            document.getElementById('max-response-length').value = data.config.max_response_length;
            document.getElementById('retention-days').value = data.config.retention_days;
        }
    } catch (error) {
        console.error('Failed to load global config:', error);
    }
}

async function loadEndpoints() {
    try {
        const response = await auth.fetch('/api/admin/logging/endpoints');
        if (response && response.ok) {
            const data = await response.json();
            endpointsData = data.endpoints;
            renderEndpointsTable();
        }
    } catch (error) {
        console.error('Failed to load endpoints:', error);
    }
}

async function loadStats() {
    try {
        const response = await auth.fetch('/api/admin/logging/stats');
        if (response && response.ok) {
            const data = await response.json();
            const stats = data.stats;
            
            document.getElementById('total-requests').textContent = stats.total_requests.toLocaleString();
            document.getElementById('error-rate').textContent = stats.error_rate + '%';
            document.getElementById('active-endpoints').textContent = stats.endpoints_count;
        }
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

async function loadLogFiles() {
    try {
        const response = await auth.fetch('/api/admin/logging/log-files');
        if (response && response.ok) {
            const data = await response.json();
            document.getElementById('log-files-count').textContent = data.total_files;
            renderLogFilesTable(data.log_files);
        }
    } catch (error) {
        console.error('Failed to load log files:', error);
    }
}

function renderEndpointsTable() {
    const tbody = document.querySelector('#endpoints-table tbody');
    tbody.innerHTML = '';
    
    endpointsData.forEach(endpoint => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>
                <input type="checkbox" class="endpoint-checkbox" data-path="${endpoint.path}" data-method="${endpoint.method}">
            </td>
            <td>
                <span class="badge badge-${getMethodColor(endpoint.method)}">${endpoint.method}</span>
            </td>
            <td><code>${endpoint.path}</code></td>
            <td>
                <input type="checkbox" ${endpoint.enabled ? 'checked' : ''} 
                       onchange="updateEndpointConfig('${endpoint.path}', '${endpoint.method}', 'enabled', this.checked)">
            </td>
            <td>
                <select onchange="updateEndpointConfig('${endpoint.path}', '${endpoint.method}', 'log_level', this.value)">
                    <option value="DEBUG" ${endpoint.log_level === 'DEBUG' ? 'selected' : ''}>DEBUG</option>
                    <option value="INFO" ${endpoint.log_level === 'INFO' ? 'selected' : ''}>INFO</option>
                    <option value="WARNING" ${endpoint.log_level === 'WARNING' ? 'selected' : ''}>WARNING</option>
                    <option value="ERROR" ${endpoint.log_level === 'ERROR' ? 'selected' : ''}>ERROR</option>
                </select>
            </td>
            <td>
                <input type="checkbox" ${endpoint.log_request_body ? 'checked' : ''} 
                       onchange="updateEndpointConfig('${endpoint.path}', '${endpoint.method}', 'log_request_body', this.checked)">
            </td>
            <td>
                <input type="checkbox" ${endpoint.log_response_body ? 'checked' : ''} 
                       onchange="updateEndpointConfig('${endpoint.path}', '${endpoint.method}', 'log_response_body', this.checked)">
            </td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="viewEndpointLogs('${endpoint.path}', '${endpoint.method}')">
                    <i class="fas fa-eye"></i> View Logs
                </button>
            </td>
        `;
    });
}

function renderLogFilesTable(logFiles) {
    const tbody = document.querySelector('#log-files-table tbody');
    tbody.innerHTML = '';
    
    logFiles.forEach(file => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${file.name}</td>
            <td>${file.size_mb} MB</td>
            <td>${file.line_count.toLocaleString()}</td>
            <td>${new Date(file.last_modified).toLocaleString()}</td>
            <td>
                <button class="btn btn-sm btn-outline-warning" onclick="clearLogFile('${file.name}')">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </td>
        `;
    });
}

function getMethodColor(method) {
    const colors = {
        'GET': 'success',
        'POST': 'primary',
        'PUT': 'warning',
        'DELETE': 'danger',
        'PATCH': 'info'
    };
    return colors[method] || 'secondary';
}

async function saveGlobalConfig() {
    try {
        showLoading();
        
        const config = {
            global_enabled: document.getElementById('global-enabled').checked,
            log_level: document.getElementById('log-level').value,
            max_response_length: parseInt(document.getElementById('max-response-length').value),
            retention_days: parseInt(document.getElementById('retention-days').value)
        };
        
        const response = await auth.fetch('/api/admin/logging/config', {
            method: 'POST',
            body: JSON.stringify(config)
        });
        
        if (response && response.ok) {
            showToast('Global configuration saved successfully', 'success');
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to save configuration', 'danger');
        }
    } catch (error) {
        console.error('Failed to save config:', error);
        showToast('Network error occurred', 'danger');
    } finally {
        hideLoading();
    }
}

function updateEndpointConfig(path, method, field, value) {
    // Update local data
    const endpoint = endpointsData.find(e => e.path === path && e.method === method);
    if (endpoint) {
        endpoint[field] = value;
    }
}

async function saveEndpointConfigs() {
    try {
        showLoading();
        
        const configs = endpointsData.map(endpoint => ({
            path: endpoint.path,
            method: endpoint.method,
            enabled: endpoint.enabled,
            log_level: endpoint.log_level,
            log_request_body: endpoint.log_request_body,
            log_response_body: endpoint.log_response_body
        }));
        
        const response = await auth.fetch('/api/admin/logging/endpoint-config/bulk', {
            method: 'POST',
            body: JSON.stringify(configs)
        });
        
        if (response && response.ok) {
            showToast('Endpoint configurations saved successfully', 'success');
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to save configurations', 'danger');
        }
    } catch (error) {
        console.error('Failed to save endpoint configs:', error);
        showToast('Network error occurred', 'danger');
    } finally {
        hideLoading();
    }
}

async function loadLogs() {
    try {
        const logType = document.getElementById('log-type-select').value;
        const limit = document.getElementById('log-limit').value;
        
        const response = await auth.fetch(`/api/admin/logging/logs?log_type=${logType}&limit=${limit}`);
        if (response && response.ok) {
            const data = await response.json();
            renderLogs(data.logs);
        }
    } catch (error) {
        console.error('Failed to load logs:', error);
        document.getElementById('log-entries').innerHTML = 'Failed to load logs';
    }
}

function renderLogs(logs) {
    const container = document.getElementById('log-entries');
    
    if (logs.length === 0) {
        container.innerHTML = 'No logs found';
        return;
    }
    
    const logHtml = logs.map(log => {
        const timestamp = log.log_timestamp || log.timestamp;
        const level = log.level || 'INFO';
        const levelColor = getLevelColor(level);
        
        return `
            <div class="mb-2 p-2 border-left border-${levelColor}">
                <div class="d-flex justify-content-between">
                    <span class="text-${levelColor}">[${level}]</span>
                    <span class="text-muted">${timestamp}</span>
                </div>
                <div><strong>${log.method || ''} ${log.path || ''}</strong></div>
                <div>IP: ${log.client_ip || 'unknown'} | Status: ${log.status_code || 'N/A'} | Time: ${log.response_time_ms || 'N/A'}ms</div>
                ${log.error ? `<div class="text-danger">Error: ${log.error}</div>` : ''}
                ${log.request_body ? `<details><summary>Request Body</summary><pre>${JSON.stringify(JSON.parse(log.request_body), null, 2)}</pre></details>` : ''}
                ${log.response_body ? `<details><summary>Response Body</summary><pre>${log.response_body}</pre></details>` : ''}
            </div>
        `;
    }).join('');
    
    container.innerHTML = logHtml;
}

function getLevelColor(level) {
    const colors = {
        'DEBUG': 'info',
        'INFO': 'primary',
        'WARNING': 'warning',
        'ERROR': 'danger'
    };
    return colors[level] || 'secondary';
}

function enableAllEndpoints() {
    endpointsData.forEach(endpoint => endpoint.enabled = true);
    renderEndpointsTable();
}

function disableAllEndpoints() {
    endpointsData.forEach(endpoint => endpoint.enabled = false);
    renderEndpointsTable();
}

function showSearchModal() {
    const modal = new bootstrap.Modal(document.getElementById('searchModal'));
    modal.show();
}

async function searchLogs() {
    try {
        showLoading();
        
        const searchParams = {
            start_date: document.getElementById('search-start-date').value || null,
            end_date: document.getElementById('search-end-date').value || null,
            client_ip: document.getElementById('search-client-ip').value || null,
            path: document.getElementById('search-path').value || null,
            method: document.getElementById('search-method').value || null,
            status_code: document.getElementById('search-status-code').value ? parseInt(document.getElementById('search-status-code').value) : null,
            min_response_time: document.getElementById('search-min-response-time').value ? parseFloat(document.getElementById('search-min-response-time').value) : null,
            log_level: document.getElementById('search-log-level').value || null,
            limit: 200
        };
        
        const response = await auth.fetch('/api/admin/logging/logs/search', {
            method: 'POST',
            body: JSON.stringify(searchParams)
        });
        
        if (response && response.ok) {
            const data = await response.json();
            renderLogs(data.logs);
            $('#searchModal').modal('hide');
            showToast(`Found ${data.total} matching logs`, 'success');
        }
    } catch (error) {
        console.error('Failed to search logs:', error);
        showToast('Search failed', 'danger');
    } finally {
        hideLoading();
    }
}

async function clearOldLogs() {
    const days = prompt('Clear logs older than how many days?', '30');
    if (!days) return;
    
    try {
        showLoading();
        
        const response = await auth.fetch(`/api/admin/logging/logs/clear?older_than_days=${days}`, {
            method: 'DELETE'
        });
        
        if (response && response.ok) {
            showToast('Old logs cleared successfully', 'success');
            loadLogFiles();
        }
    } catch (error) {
        console.error('Failed to clear old logs:', error);
        showToast('Failed to clear logs', 'danger');
    } finally {
        hideLoading();
    }
}

async function clearAllLogs() {
    if (!confirm('Are you sure you want to clear ALL logs? This action cannot be undone.')) {
        return;
    }
    
    try {
        showLoading();
        
        const response = await auth.fetch('/api/admin/logging/logs/clear', {
            method: 'DELETE'
        });
        
        if (response && response.ok) {
            showToast('All logs cleared successfully', 'success');
            loadLogFiles();
            loadLogs();
        }
    } catch (error) {
        console.error('Failed to clear all logs:', error);
        showToast('Failed to clear logs', 'danger');
    } finally {
        hideLoading();
    }
}

async function clearLogFile(fileName) {
    if (!confirm(`Clear ${fileName}?`)) return;
    
    try {
        showLoading();
        
        const logType = fileName.replace('.log', '');
        const response = await auth.fetch(`/api/admin/logging/logs/clear?log_type=${logType}`, {
            method: 'DELETE'
        });
        
        if (response && response.ok) {
            showToast(`${fileName} cleared successfully`, 'success');
            loadLogFiles();
        }
    } catch (error) {
        console.error('Failed to clear log file:', error);
        showToast('Failed to clear log file', 'danger');
    } finally {
        hideLoading();
    }
}
</script>
{% endblock %}
